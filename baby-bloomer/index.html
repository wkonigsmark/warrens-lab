<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Bloomer | Intelligence Terminal</title>
    <meta name="description"
        content="A premium financial dashboard for monitoring major market indices with deep statistical insights.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #05070a;
            --card-bg: rgba(255, 255, 255, 0.02);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --text-primary: #f3f4f6;
            --text-secondary: #6b7280;
            --glass-blur: blur(20px);
            --header-h: 68px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            background-image: radial-gradient(circle at 50% 0%, #111827 0%, #05070a 100%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-h);
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 0.75rem;
        }

        .brand h1 {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.01em;
            background: linear-gradient(to right, #ffffff, #9ca3af);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand span {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .global-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-group {
            display: flex;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 2px;
        }

        .toggle-group button {
            border: none;
            background: transparent;
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 6px;
        }

        .toggle-group button.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .btn-sep {
            width: 1px;
            height: 20px;
            background: var(--card-border);
            margin: 0 0.5rem;
        }

        button {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            backdrop-filter: var(--glass-blur);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        button.active-source {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        /* Market Pulse & Sectors Grid */
        .market-pulse,
        .sectors-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
            flex-grow: 1;
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.25rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        .market-pulse::-webkit-scrollbar,
        .sectors-grid::-webkit-scrollbar {
            width: 4px;
        }

        .market-pulse::-webkit-scrollbar-track,
        .sectors-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .market-pulse::-webkit-scrollbar-thumb,
        .sectors-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .market-pulse::-webkit-scrollbar-thumb:hover,
        .sectors-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pulse-card,
        .sector-heat-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 0.5rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-height: 50px;
        }

        .pulse-card .pct,
        .sector-heat-card .pct {
            font-size: 0.6rem;
            font-weight: 700;
        }

        .pulse-card:hover,
        .sector-heat-card:hover,
        .pulse-card.active,
        .sector-heat-card.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
            z-index: 1;
            position: relative;
        }

        .symbol {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .price {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            z-index: 1;
            position: relative;
        }

        .sparkline-container {
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 25px;
            opacity: 0.3;
        }

        .sparkline-canvas {
            width: 100%;
            height: 100%;
        }

        /* Sectors Heatmap Grid */
        .sectors-grid {
            /* Inherits from above */
        }

        .sector-heat-card {
            padding: 0.75rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sector-heat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .sector-heat-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .sector-heat-val {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .sector-heat-alpha {
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Drill-Down Industry Cards */
        .sector-heat-card {
            position: relative;
        }

        .sector-heat-card.has-industries::after {
            content: '›';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        /* Add Position Button on Cards */
        .card-add-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            opacity: 0;
        }

        .pulse-card:hover .card-add-btn,
        .sector-heat-card:hover .card-add-btn,
        .industry-card:hover .card-add-btn {
            opacity: 1;
        }

        .card-add-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
            transform: scale(1.1);
        }

        .sector-heat-card.has-industries.expanded::after {
            transform: translateY(-50%) rotate(90deg);
        }

        .industry-drill-down {
            grid-column: 1 / -1;
            display: none;
            gap: 0.4rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: -0.4rem;
            animation: expandDown 0.3s ease-out;
        }

        .industry-drill-down.visible {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        @keyframes expandDown {
            from {
                opacity: 0;
                transform: scaleY(0.8);
            }

            to {
                opacity: 1;
                transform: scaleY(1);
            }
        }

        .industry-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            position: relative;
        }

        .industry-card:hover,
        .industry-card.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .industry-label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .industry-price {
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .industry-pct {
            font-size: 0.6rem;
            font-weight: 600;
        }

        .pulse-info .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .pulse-info .price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .pulse-change {
            text-align: right;
        }

        .pulse-change .pct {
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Terminal Feed Styles */
        .terminal-feed {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            height: 320px;
            display: flex;
            flex-direction: column;
            margin-top: 0.5rem;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
        }

        .feed-header {
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .feed-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            scrollbar-width: thin;
        }

        .feed-item {
            font-size: 0.75rem;
            line-height: 1.4;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            animation: fadeIn 0.3s ease-out;
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.6rem;
        }

        .feed-time {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .feed-desk {
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        /* Persona Styles */
        .desk-gs {
            color: #facc15;
        }

        /* Gold Alpha */
        .desk-ms {
            color: #60a5fa;
        }

        /* Fixed Income Blue */
        .desk-bbg {
            color: #ef4444;
        }

        /* Alert Red */

        .feed-text {
            color: var(--text-primary);
        }

        .feed-impact {
            margin-top: 0.25rem;
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-card {
            background: #0a0c10;
            border: 1px solid var(--card-border);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-close {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--accent-blue);
        }

        .modal-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .modal-body h4 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .info-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
            font-size: 9px;
            cursor: pointer;
            margin-left: 0.4rem;
            transition: all 0.2s;
            vertical-align: middle;
        }

        .info-trigger:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Main Analysis View */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1rem;
            margin-top: 1rem;
            align-items: start;
        }

        .chart-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 1.25rem;
            min-height: 550px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 2rem;
        }

        .target-info {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 250px;
        }

        .target-price {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            font-size: 2.75rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
        }

        .target-label-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .target-label-row h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .target-change {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .chart-container {
            height: 400px;
            width: 100%;
        }

        .stats-sidebar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            width: 320px;
            align-content: start;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .stat-label {
            display: flex;
            align-items: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.35rem;
            font-weight: 500;
        }

        .positive {
            color: var(--accent-green);
        }

        .negative {
            color: var(--accent-red);
        }

        .last-packet {
            margin-top: 1.5rem;
            font-size: 0.65rem;
            color: var(--text-secondary);
            padding-top: 1rem;
            border-top: 1px solid var(--card-border);
            text-align: right;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        /* Portfolio Panel */
        .portfolio-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .portfolio-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .portfolio-reset {
            font-size: 0.65rem;
            color: var(--accent-red);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .portfolio-reset:hover {
            opacity: 1;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .portfolio-stat {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 0.5rem;
        }

        .portfolio-stat-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .portfolio-stat-value {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .portfolio-stat-value.large {
            font-size: 1.2rem;
        }

        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .position-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .position-card:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .position-symbol {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .position-close {
            font-size: 0.7rem;
            color: var(--accent-red);
            opacity: 0.6;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            transition: opacity 0.2s;
        }

        .position-close:hover {
            opacity: 1;
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .position-detail {
            display: flex;
            flex-direction: column;
        }

        .position-detail-label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        .position-detail-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            margin-top: 0.1rem;
        }

        .position-pnl {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 0.2rem;
            padding-top: 0.4rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .add-position-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            color: var(--accent-blue);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.75rem;
        }

        .add-position-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }

        .empty-portfolio {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* Add Position Modal */
        .add-position-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .add-position-modal.visible {
            display: flex;
        }

        .add-position-content {
            background: #0a0c10;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .side-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .side-option {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .side-option.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: var(--accent-blue);
            border: none;
            color: #fff;
        }

        .modal-btn-primary:hover {
            background: #2563eb;
        }

        .modal-btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
        }

        .modal-btn-secondary:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 1024px) {
            .dashboard-main {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 320px;
            }

            .market-pulse {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                height: auto;
                gap: 1rem;
                align-items: flex-start;
                padding-bottom: 1.5rem;
            }

            .global-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="brand">
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <h1>BABY BLOOMER</h1>
                    <span id="status-text"
                        style="font-size: 0.65rem; color: var(--accent-blue); font-family: 'JetBrains Mono', monospace; opacity: 0.8;">Simulated
                        Feed</span>
                    <span id="status-note"
                        style="font-size: 0.6rem; color: var(--text-secondary); opacity: 0; transition: opacity 0.5s;">(Initial
                        handshake may take a moment)</span>
                </div>
                <span id="terminal-v">Intelligence Terminal // Equities Mode</span>
            </div>
            <div class="global-controls">
                <div class="toggle-group">
                    <button id="p-equities" class="active" onclick="setPerspective('equities')">EQUITIES</button>
                    <button id="p-sectors" onclick="setPerspective('sectors')">SECTORS</button>
                    <button id="p-rates" onclick="setPerspective('rates')">RATES & BONDS</button>
                    <button id="p-commodities" onclick="setPerspective('commodities')">COMMODITIES</button>
                    <button id="p-currencies" onclick="setPerspective('currencies')">CURRENCIES</button>
                </div>
                <div class="btn-sep"></div>
                <button id="toggle-source-btn" onclick="toggleSource()">Go Live</button>
                <button onclick="resetAll()">Reset</button>
            </div>
        </header>

        <main class="dashboard-main">
            <section class="chart-section">
                <div class="chart-header">
                    <div class="target-info">
                        <div class="target-price" id="active-price">
                            <span style="font-size: 2.75rem; font-weight: 800;">0.00</span>
                            <span class="target-change positive" id="active-change"
                                style="font-size: 0.9rem;">+0.00%</span>
                        </div>
                        <div class="target-label-row">
                            <h2 id="active-symbol-label"
                                style="font-size: 1rem; color: var(--text-secondary); text-transform: uppercase;">S&P
                                500 Index</h2>
                            <span class="info-trigger" onclick="showEdu(activeIndex.symbol)">?</span>
                        </div>
                    </div>

                    <div style="flex-grow: 1; display: flex; justify-content: flex-end;">
                        <section class="market-pulse" id="market-pulse">
                            <!-- Pulse Cards -->
                        </section>

                        <section class="sectors-grid" id="sectors-grid" style="display: none;">
                            <!-- Sector Heatmap -->
                        </section>
                    </div>
                </div>

                <div class="chart-container" style="flex-grow: 1; min-height: 400px;">
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="last-packet" id="last-update">Last Packet: --:--:--</div>
            </section>

            <aside class="stats-sidebar">
                <div class="stat-card">
                    <div class="stat-label">
                        Sigma (Volatility)
                        <span class="info-trigger" onclick="showEdu('sigma')">?</span>
                    </div>
                    <div class="stat-value" id="sigma-val">0.000%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span id="multiple-label">Multiple (P/μ)</span>
                        <span class="info-trigger" onclick="showEdu('multiple')">?</span>
                    </div>
                    <div class="stat-value" id="multiple-val">1.0000x</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span id="mean-label">Rolling Mean</span>
                        <span class="info-trigger" onclick="showEdu('mean')">?</span>
                    </div>
                    <div class="stat-value" id="mean-val">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        Market Regime
                        <span class="info-trigger" onclick="showEdu('regime')">?</span>
                    </div>
                    <div class="stat-value" id="market-regime" style="font-size: 0.9rem;">Neutral</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span id="extra-label">Spread / Delta</span>
                        <span class="info-trigger" onclick="showEdu('extra')">?</span>
                    </div>
                    <div class="stat-value" id="extra-val" style="font-size: 0.95rem;">--</div>
                </div>

                <div class="terminal-feed">
                    <div class="feed-header">
                        <span>Intelligence Feed // Live</span>
                        <span id="feed-count">08 Desks Active</span>
                    </div>
                    <div class="feed-container" id="terminal-feed-container">
                        <!-- Items injected via JS -->
                        <div class="feed-item">
                            <div class="feed-meta">
                                <span class="feed-time">12:00:00</span>
                                <span class="feed-desk desk-bbg">SYSTEM</span>
                            </div>
                            <div class="feed-text">Initializing analyst sub-routines...</div>
                            <div class="feed-impact">Synchronizing cross-asset matrices.</div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Panel -->
                <div class="portfolio-panel">
                    <div class="portfolio-header">
                        <span class="portfolio-title">Paper Portfolio</span>
                        <span class="portfolio-reset" onclick="resetPortfolio()">Reset</span>
                    </div>

                    <div class="portfolio-summary">
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-label">Total Value</div>
                            <div class="portfolio-stat-value large" id="portfolio-total-value">$100,000</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-label">Cash</div>
                            <div class="portfolio-stat-value" id="portfolio-cash">$100,000</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-label">Total P&L</div>
                            <div class="portfolio-stat-value positive" id="portfolio-pnl">$0.00</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-label">Return</div>
                            <div class="portfolio-stat-value positive" id="portfolio-return">0.00%</div>
                        </div>
                    </div>

                    <div id="positions-container">
                        <div class="empty-portfolio">
                            No positions yet.<br>Click "Add Position" to start trading.
                        </div>
                    </div>

                    <button class="add-position-btn" onclick="openAddPositionModal()">+ Add Position</button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Add Position Modal -->
    <div class="add-position-modal" id="add-position-modal">
        <div class="add-position-content">
            <div class="modal-title">Add Position</div>

            <div class="form-group">
                <label class="form-label">Symbol</label>
                <select class="form-select" id="position-symbol">
                    <option value="">Select a symbol...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quantity (Shares)</label>
                <input type="number" class="form-input" id="position-quantity" placeholder="100" min="1">
            </div>

            <div class="form-group">
                <label class="form-label">Side</label>
                <div class="side-toggle">
                    <div class="side-option active" id="side-long" onclick="selectSide('long')">Long</div>
                    <div class="side-option" id="side-short" onclick="selectSide('short')">Short</div>
                </div>
            </div>

            <div class="form-group">
                <div class="portfolio-stat-label">Estimated Cost</div>
                <div class="portfolio-stat-value" id="estimated-cost">$0.00</div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeAddPositionModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmAddPosition()">Add Position</button>
            </div>
        </div>
    </div>

    <!-- Educational Modal -->
    <div class="modal-overlay" id="edu-modal">
        <div class="modal-card">
            <button class="modal-close" onclick="hideEdu()">&times;</button>
            <div id="modal-content">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <script>
        const EQUIPMENT = {
            equities: [
                // US Large Cap
                { symbol: '^GSPC', label: 'S&P 500', base: 5000 },
                { symbol: '^IXIC', label: 'Nasdaq Composite', base: 16000 },
                { symbol: '^DJI', label: 'Dow Jones', base: 38000 },
                { symbol: '^RUT', label: 'Russell 2000', base: 2000 },
                // US Mid/Small Cap
                { symbol: '^MID', label: 'S&P 400 MidCap', base: 2800 },
                { symbol: '^SML', label: 'S&P 600 SmallCap', base: 1300 },
                { symbol: '^W5000', label: 'Wilshire 5000', base: 45000 },
                { symbol: '^NYA', label: 'NYSE Composite', base: 17500 },
                // Alternative Weighting
                { symbol: 'RSP', label: 'S&P Equal Weight', base: 165 },
                // International
                { symbol: '^FTSE', label: 'FTSE 100 (UK)', base: 7500 },
                { symbol: '^GDAXI', label: 'DAX (Germany)', base: 17000 },
                { symbol: '^FCHI', label: 'CAC 40 (France)', base: 7400 },
                { symbol: '^N225', label: 'Nikkei 225 (Japan)', base: 37000 },
                { symbol: '^HSI', label: 'Hang Seng (HK)', base: 17000 },
                { symbol: '000001.SS', label: 'Shanghai Comp', base: 3000 },
                { symbol: 'EEM', label: 'MSCI Emerging Mkts', base: 40 },
                { symbol: 'URTH', label: 'MSCI World', base: 140 },
                // Volatility
                { symbol: 'VIX', label: 'Volatility Index', base: 15 }
            ],
            rates: [
                { symbol: '^TNX', label: '10Y Yield', base: 4.25, isYield: true },
                { symbol: '^TYX', label: '30Y Yield', base: 4.40, isYield: true },
                { symbol: '^FVX', label: '5Y Yield', base: 4.15, isYield: true },
                { symbol: 'DX-Y.NYB', label: 'US Dollar Index', base: 104 }
            ],
            sectors: [
                { symbol: 'XLK', label: 'Technology', base: 200 },
                { symbol: 'XLF', label: 'Financials', base: 40 },
                { symbol: 'XLV', label: 'Healthcare', base: 140 },
                { symbol: 'XLY', label: 'Discretionary', base: 180 },
                { symbol: 'XLC', label: 'Communication', base: 75 },
                { symbol: 'XLI', label: 'Industrials', base: 120 },
                { symbol: 'XLP', label: 'Staples', base: 70 },
                { symbol: 'XLE', label: 'Energy', base: 85 },
                { symbol: 'XLU', label: 'Utilities', base: 65 },
                { symbol: 'XLRE', label: 'Real Estate', base: 40 },
                { symbol: 'XLB', label: 'Materials', base: 80 }
            ],
            commodities: [
                { symbol: 'GLD', label: 'Gold', base: 180 },
                { symbol: 'SLV', label: 'Silver', base: 22 },
                { symbol: 'USO', label: 'Crude Oil', base: 70 },
                { symbol: 'UNG', label: 'Natural Gas', base: 8 },
                { symbol: 'COPX', label: 'Copper', base: 45 }
            ],
            currencies: [
                { symbol: 'EURUSD', label: 'EUR/USD', base: 1.08, isCurrency: true },
                { symbol: 'GBPUSD', label: 'GBP/USD', base: 1.26, isCurrency: true },
                { symbol: 'USDJPY', label: 'USD/JPY', base: 150, isCurrency: true },
                { symbol: 'USDCHF', label: 'USD/CHF', base: 0.88, isCurrency: true }
            ],
            industries: {
                'XLK': [ // Technology
                    { symbol: 'SOXX', label: 'Semiconductors', base: 220, parentSector: 'XLK' },
                    { symbol: 'IGV', label: 'Software', base: 400, parentSector: 'XLK' },
                    { symbol: 'HACK', label: 'Cybersecurity', base: 55, parentSector: 'XLK' }
                ],
                'XLF': [ // Financials
                    { symbol: 'KBE', label: 'Banks', base: 50, parentSector: 'XLF' },
                    { symbol: 'KIE', label: 'Insurance', base: 80, parentSector: 'XLF' },
                    { symbol: 'VNQ', label: 'REITs', base: 85, parentSector: 'XLF' }
                ],
                'XLV': [ // Healthcare
                    { symbol: 'IBB', label: 'Biotech', base: 130, parentSector: 'XLV' },
                    { symbol: 'IHE', label: 'Pharmaceuticals', base: 280, parentSector: 'XLV' },
                    { symbol: 'IHI', label: 'Medical Devices', base: 300, parentSector: 'XLV' }
                ],
                'XLY': [ // Consumer Discretionary
                    { symbol: 'XRT', label: 'Retail', base: 65, parentSector: 'XLY' },
                    { symbol: 'XHB', label: 'Homebuilders', base: 95, parentSector: 'XLY' },
                    { symbol: 'CARZ', label: 'Autos', base: 45, parentSector: 'XLY' }
                ],
                'XLC': [ // Communication
                    { symbol: 'FDN', label: 'Internet/Social', base: 200, parentSector: 'XLC' },
                    { symbol: 'VOX', label: 'Telecom', base: 90, parentSector: 'XLC' }
                ],
                'XLI': [ // Industrials
                    { symbol: 'ITA', label: 'Aerospace/Defense', base: 140, parentSector: 'XLI' },
                    { symbol: 'IYT', label: 'Transportation', base: 65, parentSector: 'XLI' },
                    { symbol: 'PKB', label: 'Construction', base: 40, parentSector: 'XLI' }
                ],
                'XLP': [ // Consumer Staples
                    { symbol: 'PBJ', label: 'Food & Beverage', base: 40, parentSector: 'XLP' },
                    { symbol: 'IYK', label: 'Household Products', base: 180, parentSector: 'XLP' }
                ],
                'XLE': [ // Energy
                    { symbol: 'XOP', label: 'Oil & Gas Exploration', base: 130, parentSector: 'XLE' },
                    { symbol: 'OIH', label: 'Oil Services', base: 280, parentSector: 'XLE' },
                    { symbol: 'ICLN', label: 'Clean Energy', base: 20, parentSector: 'XLE' }
                ],
                'XLU': [ // Utilities
                    { symbol: 'IDU', label: 'Electric Utilities', base: 110, parentSector: 'XLU' },
                    { symbol: 'PHO', label: 'Water Utilities', base: 55, parentSector: 'XLU' }
                ],
                'XLRE': [ // Real Estate
                    { symbol: 'REZ', label: 'Residential REITs', base: 70, parentSector: 'XLRE' },
                    { symbol: 'KBWY', label: 'Commercial REITs', base: 30, parentSector: 'XLRE' }
                ],
                'XLB': [ // Materials
                    { symbol: 'XME', label: 'Metals & Mining', base: 60, parentSector: 'XLB' },
                    { symbol: 'SLX', label: 'Steel', base: 65, parentSector: 'XLB' }
                ]
            },
            stocks: [
                // Technology
                { symbol: 'AAPL', label: 'Apple Inc.', base: 180, sector: 'XLK' },
                { symbol: 'MSFT', label: 'Microsoft Corp.', base: 420, sector: 'XLK' },
                { symbol: 'NVDA', label: 'NVIDIA Corp.', base: 880, sector: 'XLK' },
                { symbol: 'GOOGL', label: 'Alphabet Inc.', base: 145, sector: 'XLK' },
                { symbol: 'META', label: 'Meta Platforms', base: 485, sector: 'XLC' },
                { symbol: 'AMZN', label: 'Amazon.com Inc.', base: 175, sector: 'XLY' },
                { symbol: 'TSLA', label: 'Tesla Inc.', base: 250, sector: 'XLY' },
                { symbol: 'AMD', label: 'Advanced Micro Devices', base: 165, sector: 'XLK' },
                { symbol: 'INTC', label: 'Intel Corp.', base: 22, sector: 'XLK' },
                { symbol: 'CRM', label: 'Salesforce Inc.', base: 280, sector: 'XLK' },
                // Financials
                { symbol: 'JPM', label: 'JPMorgan Chase', base: 195, sector: 'XLF' },
                { symbol: 'BAC', label: 'Bank of America', base: 38, sector: 'XLF' },
                { symbol: 'GS', label: 'Goldman Sachs', base: 450, sector: 'XLF' },
                { symbol: 'MS', label: 'Morgan Stanley', base: 105, sector: 'XLF' },
                { symbol: 'WFC', label: 'Wells Fargo', base: 58, sector: 'XLF' },
                { symbol: 'BRK-B', label: 'Berkshire Hathaway', base: 420, sector: 'XLF' },
                { symbol: 'V', label: 'Visa Inc.', base: 280, sector: 'XLF' },
                // Healthcare
                { symbol: 'JNJ', label: 'Johnson & Johnson', base: 160, sector: 'XLV' },
                { symbol: 'UNH', label: 'UnitedHealth Group', base: 520, sector: 'XLV' },
                { symbol: 'PFE', label: 'Pfizer Inc.', base: 28, sector: 'XLV' },
                { symbol: 'ABBV', label: 'AbbVie Inc.', base: 175, sector: 'XLV' },
                { symbol: 'LLY', label: 'Eli Lilly', base: 780, sector: 'XLV' },
                { symbol: 'MRK', label: 'Merck & Co.', base: 100, sector: 'XLV' },
                // Energy
                { symbol: 'XOM', label: 'Exxon Mobil', base: 110, sector: 'XLE' },
                { symbol: 'CVX', label: 'Chevron Corp.', base: 155, sector: 'XLE' },
                { symbol: 'COP', label: 'ConocoPhillips', base: 110, sector: 'XLE' },
                { symbol: 'SLB', label: 'Schlumberger', base: 45, sector: 'XLE' },
                // Consumer
                { symbol: 'WMT', label: 'Walmart Inc.', base: 68, sector: 'XLP' },
                { symbol: 'PG', label: 'Procter & Gamble', base: 165, sector: 'XLP' },
                { symbol: 'KO', label: 'Coca-Cola Co.', base: 62, sector: 'XLP' },
                { symbol: 'PEP', label: 'PepsiCo Inc.', base: 170, sector: 'XLP' },
                { symbol: 'COST', label: 'Costco Wholesale', base: 850, sector: 'XLP' },
                { symbol: 'NKE', label: 'Nike Inc.', base: 85, sector: 'XLY' },
                { symbol: 'HD', label: 'Home Depot', base: 380, sector: 'XLY' },
                { symbol: 'MCD', label: "McDonald's Corp.", base: 295, sector: 'XLY' },
                // Industrials
                { symbol: 'BA', label: 'Boeing Co.', base: 175, sector: 'XLI' },
                { symbol: 'CAT', label: 'Caterpillar Inc.', base: 350, sector: 'XLI' },
                { symbol: 'GE', label: 'General Electric', base: 165, sector: 'XLI' },
                { symbol: 'UPS', label: 'United Parcel Service', base: 130, sector: 'XLI' }
            ]
        };


        let activePerspective = 'equities';
        let activeIndex = EQUIPMENT.equities[0];
        let state = {}; // Stores { symbol: { dataPoints, labels, currentPrice, basePrice } }
        let expandedSector = null; // Track which sector is currently expanded

        // Portfolio State
        let portfolio = {
            cash: 100000,
            startingCapital: 100000,
            positions: [], // { id, symbol, label, quantity, entryPrice, entryTime, side: 'long'|'short', sector }
            nextPositionId: 1
        };

        let chart;
        let isRealData = false;
        let updateInterval;
        let lastPulseTime = 0;
        const baselineSignals = [
            { desk: "GS STRATEGY", text: "Cross-asset correlation matrices remain within normal parameters.", impact: "No immediate structural shifts detected." },
            { desk: "MS RATES", text: "Treasury auction results coming in line with expectations.", impact: "Duration supply being absorbed; yield floor potentially forming." },
            { desk: "BLOOMBERG", text: "Global capital flows continuing to favor US-denominated assets.", impact: "Strong USD (DXY) remains the primary macro anchor." },
            { desk: "GS STRATEGY", text: "Monitoring sector momentum for signs of distribution.", impact: "Broad market breadth remains healthy." },
            { desk: "MS RATES", text: "Fed swap markets pricing in a stable terminal rate for now.", impact: "Volatility on the front end of the curve is muted." }
        ];

        // Initialize state for all possible symbols including industries and stocks
        const allIndustries = Object.values(EQUIPMENT.industries).flat();
        [...EQUIPMENT.equities, ...EQUIPMENT.rates, ...EQUIPMENT.sectors, ...EQUIPMENT.commodities, ...EQUIPMENT.currencies, ...allIndustries, ...EQUIPMENT.stocks].forEach(idx => {
            state[idx.symbol] = {
                dataPoints: [],
                labels: [],
                currentPrice: idx.base,
                basePrice: idx.base
            };
        });

        // Load portfolio from localStorage
        function loadPortfolio() {
            const saved = localStorage.getItem('babyBloomerPortfolio');
            if (saved) {
                try {
                    portfolio = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load portfolio:', e);
                }
            }
            updatePortfolioUI();
        }

        // Save portfolio to localStorage
        function savePortfolio() {
            localStorage.setItem('babyBloomerPortfolio', JSON.stringify(portfolio));
        }

        // Reset portfolio
        function resetPortfolio() {
            if (confirm('Reset portfolio to $100,000 and close all positions?')) {
                portfolio = {
                    cash: 100000,
                    startingCapital: 100000,
                    positions: [],
                    nextPositionId: 1
                };
                savePortfolio();
                updatePortfolioUI();
            }
        }

        function setPerspective(p) {
            activePerspective = p;
            activeIndex = EQUIPMENT[p][0];

            // Toggle UI Buttons
            document.querySelectorAll('.toggle-group button').forEach(b => b.classList.remove('active'));
            document.getElementById(`p-${p}`).classList.add('active');

            document.getElementById('terminal-v').textContent = `Intelligence Terminal // ${p.charAt(0).toUpperCase() + p.slice(1)} Mode`;

            // Update labels and visibility
            const pulse = document.getElementById('market-pulse');
            const sectors = document.getElementById('sectors-grid');

            if (p === 'rates') {
                document.getElementById('multiple-label').textContent = 'Yield Multiple (Y/μ)';
                document.getElementById('mean-label').textContent = 'Rolling Yield Mean';
                pulse.style.display = 'grid';
                sectors.style.display = 'none';
            } else if (p === 'sectors') {
                document.getElementById('multiple-label').textContent = 'Alpha (Rel Strategy)';
                document.getElementById('mean-label').textContent = 'Sector Peer Mean';
                pulse.style.display = 'none';
                sectors.style.display = 'grid';
            } else if (p === 'commodities') {
                document.getElementById('multiple-label').textContent = 'Price Multiple (P/μ)';
                document.getElementById('mean-label').textContent = 'Rolling Commodity Mean';
                pulse.style.display = 'grid';
                sectors.style.display = 'none';
            } else if (p === 'currencies') {
                document.getElementById('multiple-label').textContent = 'FX Multiple (Rate/μ)';
                document.getElementById('mean-label').textContent = 'Rolling FX Mean';
                pulse.style.display = 'grid';
                sectors.style.display = 'none';
            } else {
                document.getElementById('multiple-label').textContent = 'Price Multiple (P/μ)';
                document.getElementById('mean-label').textContent = 'Rolling Price Mean';
                pulse.style.display = 'grid';
                sectors.style.display = 'none';
            }

            initUI();
            switchIndex(activeIndex);
        }

        function initUI() {
            const pulse = document.getElementById('market-pulse');
            const sectorGrid = document.getElementById('sectors-grid');

            pulse.innerHTML = '';
            sectorGrid.innerHTML = '';

            EQUIPMENT[activePerspective].forEach((idx, index) => {
                const s = state[idx.symbol];
                const diff = s.currentPrice - s.basePrice;
                const pct = (diff / s.basePrice * 100).toFixed(2);

                const card = document.createElement('div');
                const hasIndustries = activePerspective === 'sectors' && EQUIPMENT.industries[idx.symbol];
                card.className = `${activePerspective === 'sectors' ? 'sector-heat-card' : 'pulse-card'} ${idx.symbol === activeIndex.symbol ? 'active' : ''} ${hasIndustries ? 'has-industries' : ''} ${expandedSector === idx.symbol ? 'expanded' : ''}`;

                // For sectors with industries, clicking toggles drill-down
                if (hasIndustries) {
                    card.onclick = (e) => {
                        e.stopPropagation();
                        toggleSectorDrillDown(idx.symbol);
                    };
                } else {
                    card.onclick = () => switchIndex(idx);
                }

                card.innerHTML = `
                    <div class="card-add-btn" onclick="openAddPositionModal('${idx.symbol}'); event.stopPropagation();">+</div>
                    <div class="label-row">
                        <span class="symbol">${idx.label}</span>
                        <span class="pct ${pct >= 0 ? 'positive' : 'negative'}">${pct}%</span>
                    </div>
                    <div class="price">${formatVal(s.currentPrice, idx)}</div>
                    <div class="sparkline-container">
                        <canvas id="spark-${idx.symbol.replace(/[^^A-Z0-9]/g, '')}" class="sparkline-canvas"></canvas>
                    </div>
                `;

                if (activePerspective === 'sectors') sectorGrid.appendChild(card);
                else pulse.appendChild(card);

                // Draw Sparkline
                setTimeout(() => drawSparkline(`spark-${idx.symbol.replace(/[^^A-Z0-9]/g, '')}`, s.dataPoints), 0);

                // Add drill-down panel if this sector is expanded
                if (hasIndustries && expandedSector === idx.symbol) {
                    const drillDown = document.createElement('div');
                    drillDown.className = 'industry-drill-down visible';

                    EQUIPMENT.industries[idx.symbol].forEach(industry => {
                        const indState = state[industry.symbol];
                        const indDiff = indState.currentPrice - indState.basePrice;
                        const indPct = (indDiff / indState.basePrice * 100).toFixed(2);

                        const industryCard = document.createElement('div');
                        industryCard.className = `industry-card ${industry.symbol === activeIndex.symbol ? 'active' : ''}`;
                        industryCard.onclick = (e) => {
                            e.stopPropagation();
                            switchIndex(industry);
                        };

                        industryCard.innerHTML = `
                            <div class="card-add-btn" onclick="openAddPositionModal('${industry.symbol}'); event.stopPropagation();">+</div>
                            <div class="industry-label">${industry.label}</div>
                            <div class="industry-price">${formatVal(indState.currentPrice, industry)}</div>
                            <div class="industry-pct ${indPct >= 0 ? 'positive' : 'negative'}">${indPct >= 0 ? '+' : ''}${indPct}%</div>
                        `;

                        drillDown.appendChild(industryCard);
                    });

                    sectorGrid.appendChild(drillDown);
                }
            });
        }

        function toggleSectorDrillDown(sectorSymbol) {
            if (expandedSector === sectorSymbol) {
                expandedSector = null;
            } else {
                expandedSector = sectorSymbol;
            }
            initUI();
        }

        function drawSparkline(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || data.length < 2) return;

            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);

            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;

            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.lineWidth = 1.5;

            const color = data[data.length - 1] >= data[0] ? '#10b981' : '#ef4444';
            ctx.strokeStyle = color;

            data.forEach((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Subtle fill
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.fillStyle = color + '15';
            ctx.fill();
        }

        function switchIndex(idx) {
            activeIndex = idx;
            // document.querySelectorAll('.pulse-card').forEach(c => c.classList.remove('active')); // Removed as initUI handles active state
            const s = state[activeIndex.symbol]; // Ensure 's' is defined for the active index
            if (!s) return;

            chart.data.labels = s.labels;
            chart.data.datasets[0].data = s.dataPoints;
            chart.data.datasets[0].label = activeIndex.label;

            // Show breadcrumb for industries
            let labelText = idx.label;
            if (idx.parentSector) {
                const parentSectorObj = EQUIPMENT.sectors.find(s => s.symbol === idx.parentSector);
                if (parentSectorObj) {
                    labelText = `${parentSectorObj.label} › ${idx.label}`;
                }
            }
            document.getElementById('active-symbol-label').textContent = labelText;

            // Set chart color based on mode
            if (activePerspective === 'rates') {
                chart.data.datasets[0].borderColor = '#3b82f6';
                chart.data.datasets[0].backgroundColor = (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.1)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                    return gradient;
                };
            } else if (activePerspective === 'sectors') {
                chart.data.datasets[0].borderColor = '#a855f7'; // Purple for sectors
                chart.data.datasets[0].backgroundColor = (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(168, 85, 247, 0.1)');
                    gradient.addColorStop(1, 'rgba(168, 85, 247, 0)');
                    return gradient;
                };
            } else {
                chart.data.datasets[0].borderColor = '#10b981';
                chart.data.datasets[0].backgroundColor = (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.1)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                    return gradient;
                };
            }

            updateStats();
            chart.update('none');
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: activeIndex.label,
                        data: [],
                        borderColor: '#10b981',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#0a0c10',
                            borderColor: 'rgba(255,255,255,0.08)',
                            borderWidth: 1,
                            titleFont: { family: 'JetBrains Mono', size: 10 },
                            bodyFont: { family: 'JetBrains Mono', size: 12 },
                            padding: 10
                        }
                    },
                    scales: {
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(255, 255, 255, 0.03)' },
                            ticks: {
                                color: '#4b5563',
                                font: { size: 9, family: 'JetBrains Mono' },
                                callback: val => activeIndex.isYield ? val.toFixed(3) + '%' : val.toLocaleString()
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#4b5563',
                                font: { size: 9, family: 'JetBrains Mono' },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        }
                    }
                }
            });
        }

        const fetchSymbol = async (idx) => {
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${idx.symbol}?interval=2min&range=1d&includePrePost=false`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Proxy error: ${response.status}`);
                const data = await response.json();

                if (!data || !data.chart || !data.chart.result) {
                    if (data.chart && data.chart.error) {
                        throw new Error(`Yahoo Finance Error: ${data.chart.error.description}`);
                    }
                    throw new Error("Invalid Chart Data structure");
                }

                const res = data.chart.result[0];
                const meta = res.meta;
                const timestamps = res.timestamp || [];
                const quotes = res.indicators.quote[0].close || [];

                const pts = [];
                const lbls = [];
                quotes.forEach((q, i) => {
                    if (q !== null && q !== undefined) {
                        pts.push(q);
                        lbls.push(new Date(timestamps[i] * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    }
                });

                if (pts.length > 0) {
                    state[idx.symbol] = {
                        dataPoints: pts,
                        labels: lbls,
                        currentPrice: pts[pts.length - 1],
                        basePrice: meta.regularMarketPreviousClose || meta.chartPreviousClose || pts[0]
                    };
                    return true;
                }
                return false;
            } catch (e) {
                console.error(`[Connectivity] Error fetching ${idx.symbol}:`, e.message);
                return false;
            }
        };

        async function fetchAllData() {
            const status = document.getElementById('status-text');
            const note = document.getElementById('status-note');
            status.textContent = "Live Stream: Connecting...";
            status.style.color = "var(--accent-blue)";
            note.style.opacity = "0.5";
            pushToFeed("SYSTEM", "Initiating handshake with external proxy...", "Requesting CORS-cleared socket to Yahoo Finance.");

            const allSymbols = [
                ...EQUIPMENT.equities,
                ...EQUIPMENT.rates,
                ...EQUIPMENT.sectors,
                ...EQUIPMENT.commodities,
                ...EQUIPMENT.currencies
            ];

            let successCount = 0;
            // Use individual await to ensure robustness
            for (const sym of allSymbols) {
                const ok = await fetchSymbol(sym);
                if (ok) successCount++;
            }

            if (successCount > 0) {
                status.textContent = "Live Stream: Active";
                status.style.color = "var(--accent-green)";
                note.style.opacity = "0";
                isRealData = true;
                document.getElementById('toggle-source-btn').textContent = "Simulation Mode";
                document.getElementById('toggle-source-btn').classList.add('active-source');
                pushToFeed("SYSTEM", "Live Connectivity Established.", `Synchronized ${successCount}/${allSymbols.length} market assets.`);
                updateUI();
                switchIndex(activeIndex);
            } else {
                status.textContent = "Live Stream: Connection Failed";
                status.style.color = "var(--accent-red)";
                note.textContent = "(Check browser console for details)";
                note.style.opacity = "0.8";
                pushToFeed("BLOOMBERG", "External data pipe failed.", "Handshake rejection detected. Falling back to simulation.");
                setTimeout(() => { if (!isRealData) toggleSource(); }, 3000); // Fallback to sim
            }
        }
        function updateSimulation() {
            [...EQUIPMENT.equities, ...EQUIPMENT.rates, ...EQUIPMENT.sectors, ...EQUIPMENT.commodities, ...EQUIPMENT.currencies].forEach(idx => {
                const s = state[idx.symbol];
                const scale = idx.isYield ? 0.005 : (idx.base * 0.0005);
                const drift = (Math.random() - 0.498) * scale;
                s.currentPrice += drift;

                const now = new Date();
                s.labels.push(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                s.dataPoints.push(s.currentPrice);

                if (s.dataPoints.length > 200) {
                    s.labels.shift();
                    s.dataPoints.shift();
                }
            });

            updateUI();
            updateSignalBox();
            const s = state[activeIndex.symbol];
            chart.data.labels = s.labels;
            chart.data.datasets[0].data = s.dataPoints;
            chart.update('none');
            updateStats();
        }

        function formatVal(val, idx) {
            if (idx.isCurrency) return val.toFixed(4);
            if (idx.isYield) return val.toFixed(3) + '%';
            return val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateUI() {
            // Update the sidebar pulse list or heatmap
            initUI();

            // Update main view
            const s = state[activeIndex.symbol];
            if (!s) return;

            document.getElementById('active-price').children[0].textContent = formatVal(s.currentPrice, activeIndex);

            const diff = s.currentPrice - s.basePrice;
            const pct = (diff / s.basePrice * 100).toFixed(2);
            const mainChange = document.getElementById('active-change');

            if (activePerspective === 'sectors') {
                const spy = state['^GSPC'];
                const spyPct = ((spy.currentPrice - spy.basePrice) / spy.basePrice * 100);
                const alpha = (pct - spyPct).toFixed(2);
                mainChange.textContent = `${pct >= 0 ? '+' : ''}${pct}% (Alpha: ${alpha >= 0 ? '+' : ''}${alpha}%)`;
            } else if (activeIndex.isYield) {
                const bps = (diff * 100).toFixed(1);
                mainChange.textContent = `${bps >= 0 ? '+' : ''}${bps} bps (${pct >= 0 ? '+' : ''}${pct}%)`;
            } else {
                mainChange.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(2)} (${pct >= 0 ? '+' : ''}${pct}%)`;
            }
            mainChange.className = `target-change ${pct >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('last-update').textContent = `Last Packet: ${new Date().toLocaleTimeString()}`;

            updateStats();
        }
        function updateStats() {
            const s = state[activeIndex.symbol];
            const data = s.dataPoints;
            if (!data.length) return;

            const n = data.length;
            const mean = data.reduce((a, b) => a + b, 0) / n;
            const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            const sigma = Math.sqrt(variance);
            const multiple = s.currentPrice / mean;

            document.getElementById('mean-val').textContent = formatVal(mean, activeIndex);
            document.getElementById('sigma-val').textContent = (sigma / mean * 100).toFixed(4) + '%';
            const multipleVal = document.getElementById('multiple-val');
            if (activePerspective === 'sectors') {
                const spy = state['^GSPC'];
                const pct = (s.currentPrice - s.basePrice) / s.basePrice * 100;
                const spyPct = (spy.currentPrice - spy.basePrice) / spy.basePrice * 100;
                const alpha = (pct - spyPct).toFixed(2);
                multipleVal.textContent = `${alpha >= 0 ? '+' : ''}${alpha}%`;
                multipleVal.className = `stat-value ${alpha < 0 ? 'negative' : 'positive'}`;
            } else {
                multipleVal.textContent = multiple.toFixed(4) + 'x';
            }

            const regime = document.getElementById('market-regime');
            const threshold = activeIndex.isYield ? 1.0005 : 1.001;

            if (multiple > threshold) { regime.textContent = 'Bullish / Expanding'; regime.className = 'stat-value positive'; }
            else if (multiple < (1 / threshold)) { regime.textContent = 'Bearish / Contracting'; regime.className = 'stat-value negative'; }
            else { regime.textContent = 'Stable / Neutral'; regime.className = 'stat-value'; }

            // Extra context card (Spread)
            const extraLabel = document.getElementById('extra-label');
            const extraVal = document.getElementById('extra-val');

            if (activePerspective === 'rates') {
                const yield10 = state['^TNX'].currentPrice;
                const yield5 = state['^FVX'].currentPrice;
                const spread = (yield10 - yield5).toFixed(3);
                extraLabel.textContent = '10Y - 5Y Spread';
                extraVal.textContent = `${spread}%`;
                extraVal.className = `stat-value ${spread < 0 ? 'negative' : 'positive'}`;
            } else {
                extraLabel.textContent = 'Price Delta (μ)';
                const delta = (s.currentPrice - mean).toFixed(2);
                extraVal.textContent = delta;
                extraVal.className = `stat-value ${delta < 0 ? 'negative' : 'positive'}`;
            }

            updateSignalBox();
        }

        const EDU_CONTENT = {
            // Stats
            sigma: { title: "Sigma (Volatility)", body: "<p>Sigma measures 'Market Nervousness.' Higher sigma means bigger swings and higher risk/reward.</p>" },
            multiple: { title: "The Multiple (P/μ)", body: "<p>The ratio of current Price to the Rolling Mean. >1.0 means overextended; <1.0 means potentially oversold.</p>" },
            mean: { title: "Rolling Mean (μ)", body: "<p>The asset's center of gravity. It filters noise to reveal the true underlying trend.</p>" },
            regime: { title: "Market Regime", body: "<p>Classification of momentum: Expanding (Bullish), Contracting (Bearish), or Neutral.</p>" },

            // Equities
            '^GSPC': {
                title: "S&P 500 Index",
                body: `
                    <p>The "US Market Benchmark." It tracks 500 of the largest companies representing ~80% of available market value.</p>
                    <h4>Why it matters</h4>
                    <p>When you hear "the market is up," people usually mean the S&P 500. It is the gold standard for institutional performance.</p>
                `
            },
            '^IXIC': {
                title: "Nasdaq Composite Index",
                body: `
                    <p>The "Innovation Hub." Concentrated in high-growth technology, biotechnology, and retail companies.</p>
                    <h4>The Composition</h4>
                    <p>Includes all stocks listed on the Nasdaq exchange (~3,000 companies). Dominated by tech giants like Apple, Microsoft, and Nvidia.</p>
                `
            },
            '^DJI': {
                title: "Dow Jones Industrial Average",
                body: `
                    <p>The "Blue Chip Tracker." 30 massive, mature companies representing the backbone of the American economy.</p>
                    <h4>Unique Logic</h4>
                    <p>Unlike other indexes, the Dow is <i>price-weighted</i>. The higher a company's stock price, the more influence it has on the index.</p>
                `
            },
            '^RUT': {
                title: "Russell 2000 Index",
                body: `
                    <p>The "Main Street Pulse." Tracks 2,000 smaller companies that are more focused on the domestic US economy.</p>
                    <h4>Why it matters</h4>
                    <p>Small caps are the "canary in the coal mine." They are often the first to feel a recession and the first to rally in a recovery.</p>
                `
            },
            '^MID': {
                title: "S&P 400 MidCap Index",
                body: `
                    <p>The "Goldilocks Zone." Tracks 400 mid-sized companies that balance growth potential with operational stability.</p>
                    <h4>Why it matters</h4>
                    <p>Mid-caps often outperform both large and small caps over long periods, offering a sweet spot of risk and reward.</p>
                `
            },
            '^SML': {
                title: "S&P 600 SmallCap Index",
                body: `
                    <p>The "Pure Small Cap Play." Focuses on 600 smaller US companies with stricter profitability requirements than Russell 2000.</p>
                    <h4>Why it matters</h4>
                    <p>More quality-focused than other small cap indexes, requiring positive earnings over the trailing year.</p>
                `
            },
            '^W5000': {
                title: "Wilshire 5000 Total Market Index",
                body: `
                    <p>The "Total US Market." Represents virtually every publicly traded company in the United States.</p>
                    <h4>Why it matters</h4>
                    <p>The broadest measure of US equity market performance, capturing large, mid, and small cap stocks.</p>
                `
            },
            '^NYA': {
                title: "NYSE Composite Index",
                body: `
                    <p>The "Original Exchange Tracker." Includes all common stocks listed on the New York Stock Exchange.</p>
                    <h4>Why it matters</h4>
                    <p>Provides a comprehensive view of NYSE-listed companies, traditionally more value-oriented than Nasdaq.</p>
                `
            },
            'RSP': {
                title: "S&P 500 Equal Weight Index",
                body: `
                    <p>The "Democratic S&P." Each of the 500 companies gets equal weighting, unlike the cap-weighted S&P 500.</p>
                    <h4>Why it matters</h4>
                    <p>Reduces concentration risk from mega-cap tech. Outperforms when market breadth is strong and smaller stocks rally.</p>
                `
            },
            '^FTSE': {
                title: "FTSE 100 Index (UK)",
                body: `
                    <p>The "London Benchmark." Tracks the 100 largest companies listed on the London Stock Exchange.</p>
                    <h4>Why it matters</h4>
                    <p>Heavily weighted toward financials, energy, and consumer goods. A key indicator of European economic health.</p>
                `
            },
            '^GDAXI': {
                title: "DAX Index (Germany)",
                body: `
                    <p>The "European Engine." Germany's premier stock index tracking 40 major companies including BMW, Siemens, and SAP.</p>
                    <h4>Why it matters</h4>
                    <p>Germany is Europe's largest economy. The DAX is highly sensitive to global manufacturing and export demand.</p>
                `
            },
            '^FCHI': {
                title: "CAC 40 Index (France)",
                body: `
                    <p>The "Parisian Elite." Tracks 40 of the largest French companies including LVMH, L'Oréal, and TotalEnergies.</p>
                    <h4>Why it matters</h4>
                    <p>Heavy exposure to luxury goods and energy. A barometer for European consumer confidence and global luxury demand.</p>
                `
            },
            '^N225': {
                title: "Nikkei 225 Index (Japan)",
                body: `
                    <p>The "Tokyo Titan." Japan's most-watched index, tracking 225 large companies including Toyota, Sony, and SoftBank.</p>
                    <h4>Why it matters</h4>
                    <p>Price-weighted like the Dow. Highly sensitive to yen strength and global technology demand.</p>
                `
            },
            '^HSI': {
                title: "Hang Seng Index (Hong Kong)",
                body: `
                    <p>The "China Gateway." Tracks major companies listed in Hong Kong, including many Chinese tech giants.</p>
                    <h4>Why it matters</h4>
                    <p>A key proxy for Chinese economic growth and Asian market sentiment. Sensitive to US-China relations.</p>
                `
            },
            '000001.SS': {
                title: "Shanghai Composite Index",
                body: `
                    <p>The "Mainland Pulse." Tracks all stocks listed on the Shanghai Stock Exchange, China's primary market.</p>
                    <h4>Why it matters</h4>
                    <p>Direct exposure to China's domestic economy. Heavily influenced by government policy and capital controls.</p>
                `
            },
            'EEM': {
                title: "MSCI Emerging Markets ETF",
                body: `
                    <p>The "Global Growth Bet." Provides exposure to emerging market equities across Asia, Latin America, and Eastern Europe.</p>
                    <h4>Why it matters</h4>
                    <p>High growth potential but higher volatility. Sensitive to dollar strength, commodity prices, and global risk appetite.</p>
                `
            },
            'URTH': {
                title: "MSCI World Index ETF",
                body: `
                    <p>The "Developed Markets Portfolio." Tracks large and mid-cap stocks across 23 developed countries.</p>
                    <h4>Why it matters</h4>
                    <p>Provides diversified global equity exposure. Heavily weighted toward US stocks (~70%) but includes Europe, Japan, and others.</p>
                `
            },
            'VIX': {
                title: "CBOE Volatility Index",
                body: `
                    <p>The "Fear Gauge." Measures expected 30-day volatility based on S&P 500 options pricing.</p>
                    <h4>Why it matters</h4>
                    <p>Spikes during market stress. VIX above 20 signals elevated fear; below 15 suggests complacency.</p>
                `
            },

            // Rates
            '^TNX': {
                title: "10Y Treasury Yield",
                body: `
                    <p>The "Global Price of Money." This yields influences everything from mortgage rates to corporate borrowing costs.</p>
                    <h4>The Inverse Rule</h4>
                    <p>When yields rise, stock valuations (especially tech) often fall, as future earnings are "discounted" at a higher rate.</p>
                `
            },
            '^TYX': {
                title: "30Y Treasury Yield",
                body: `
                    <p>The "Long Lens." Reflects the market's long-term outlook on inflation and secular economic growth.</p>
                    <h4>Why it matters</h4>
                    <p>A "steepening" curve (30Y rising faster than 10Y) suggests the market is pricing in a future growth boom.</p>
                `
            },
            '^FVX': {
                title: "5Y Treasury Yield",
                body: `
                    <p>The "Belly of the Curve." This is the most sensitive area to Federal Reserve policy shifts over the medium term.</p>
                `
            },
            'DX-Y.NYB': {
                title: "US Dollar Index (DXY)",
                body: `
                    <p>The "Global Safety Valve." Measures the USD against a basket of currencies like the Euro and Yen.</p>
                    <h4>The Logic</h4>
                    <p>A strong dollar acts as a "tightening" force on global liquidity. It often puts downward pressure on Gold and Oil.</p>
                `
            },

            // Sectors
            'XLK': {
                title: "Technology (XLK)",
                body: `
                    <p>The Productivity Sector. Software, Hardware, and Semi-conductors.</p>
                    <h4>The Story</h4>
                    <p>This is the engine of the modern economy. It leads during periods of low interest rates and high innovation cycles.</p>
                `
            },
            'XLF': {
                title: "Financials (XLF)",
                body: `
                    <p>The Banking Backbone. Credit, Insurance, and Capital Markets.</p>
                    <h4>The Story</h4>
                    <p>Banks thrive when interest rate spreads widen. This sector is the ultimate proxy for lending health and credit demand.</p>
                `
            },
            'XLV': {
                title: "Healthcare (XLV)",
                body: `
                    <p>The Defensive Growth Play. Pharmaceuticals and Biotech.</p>
                    <h4>The Story</h4>
                    <p>Healthcare is a "non-discretionary" spend. People need medicine regardless of the economic cycle, making this a steady performer.</p>
                `
            },
            'XLY': {
                title: "Consumer Discretionary (XLY)",
                body: `
                    <p>The "Wants" Sector. Retail, Travel, and Automakers.</p>
                    <h4>The Story</h4>
                    <p>When consumers feel rich (rising stocks/homes), they spend here. It is a high-conviction "Risk-On" bet.</p>
                `
            },
            'XLC': {
                title: "Communication (XLC)",
                body: `
                    <p>The Digital Connection. Social Media and Advertising.</p>
                    <h4>The Story</h4>
                    <p>A hybrid of tech growth and cyclical advertising revenue. Think Alphabet and Meta.</p>
                `
            },
            'XLI': {
                title: "Industrials (XLI)",
                body: `
                    <p>The "Real" Economy. Boeing, Caterpillar, and Logistics.</p>
                    <h4>The Story</h4>
                    <p>This sector builds the physical world. It rallies when infrastructure spending and global trade are accelerating.</p>
                `
            },
            'XLP': {
                title: "Consumer Staples (XLP)",
                body: `
                    <p>The Grocery Basket. Essentials like soap, food, and household goods.</p>
                    <h4>The Story</h4>
                    <p>The ultimate defensive cluster. It outperforms when the economy is "contracting" as consumers cut luxury spending but keep the essentials.</p>
                `
            },
            'XLE': {
                title: "Energy (XLE)",
                body: `
                    <p>The Power Source. Oil, Gas, and Refineries.</p>
                    <h4>The Story</h4>
                    <p>Deeply cyclical and tied to crude oil prices. Acts as a natural hedge against inflation.</p>
                `
            },
            'XLU': {
                title: "Utilities (XLU)",
                body: `
                    <p>The Dividend Fortress. Water, Gas, and Electric providers.</p>
                    <h4>The Story</h4>
                    <p>The most bond-like sector. Investors move here for safety and dividends when they expect the market to crash.</p>
                `
            },
            'XLRE': {
                title: "Real Estate (XLRE)",
                body: `
                    <p>The Physical Frontier. REITs and Property Management.</p>
                    <h4>The Story</h4>
                    <p>Income-focused and extremely sensitive to interest rates due to mortgage and financing costs.</p>
                `
            },
            'XLB': {
                title: "Materials (XLB)",
                body: `
                    <p>The Foundation. Chemicals, Mining, and Steel.</p>
                    <h4>The Story</h4>
                    <p>An "early cycle" indicator. Demand for steel and copper picks up months before the rest of the economy starts to booom.</p>
                `
            }
        };

        function showEdu(key) {
            // Check for symbol-specific content, then stats, then default to generic sectors
            const content = EDU_CONTENT[key] || EDU_CONTENT['sectors'];
            document.getElementById('modal-content').innerHTML = `
                <h3 class="modal-title" style="color: var(--accent-blue); margin-bottom: 1rem;">${content.title}</h3>
                <div class="modal-body" style="line-height: 1.6;">${content.body}</div>
            `;
            document.getElementById('edu-modal').style.display = 'flex';
        }

        function hideEdu() {
            document.getElementById('edu-modal').style.display = 'none';
        }

        let lastSignalKey = "";
        function pushToFeed(desk, text, impact) {
            const container = document.getElementById('terminal-feed-container');
            if (!container) return;
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const signalKey = `${desk}:${text}`;
            if (signalKey === lastSignalKey) return;
            lastSignalKey = signalKey;

            const item = document.createElement('div');
            item.className = 'feed-item';

            let deskClass = 'desk-bbg';
            if (desk === 'GS STRATEGY') deskClass = 'desk-gs';
            if (desk === 'MS RATES') deskClass = 'desk-ms';

            item.innerHTML = `
                <div class="feed-meta">
                    <span class="feed-time">${time}</span>
                    <span class="feed-desk ${deskClass}">${desk}</span>
                </div>
                <div class="feed-text">${text}</div>
                <div class="feed-impact">${impact}</div>
            `;

            container.prepend(item);
            while (container.children.length > 20) container.lastElementChild.remove();
        }

        function updateSignalBox() {
            const spy = state['^GSPC'];
            const tnx = state['^TNX'];
            const dxy = state['DX-Y.NYB'];

            if (!spy || !tnx || !dxy) return;

            const spyChange = (spy.currentPrice - spy.basePrice) / spy.basePrice;
            const tnxChange = (tnx.currentPrice - tnx.basePrice) / tnx.basePrice;
            const dxyChange = (dxy.currentPrice - dxy.basePrice) / dxy.basePrice;

            let signalTriggered = false;

            if (Math.abs(tnxChange) > 0.005) {
                pushToFeed("MS RATES", tnxChange > 0 ? "Yield Pressure intensifying on the long end." : "Yield compression detected as safe-haven bids increase.", tnxChange > 0 ? "Bearish for duration-sensitive growth stocks (XLK)." : "Bullish for treasuries and high-dividend sectors.");
                signalTriggered = true;
            } else if (tnx.currentPrice < state['^FVX'].currentPrice) {
                pushToFeed("MS RATES", "Yield Curve Inversion deepening (5Y > 10Y).", "Institutional desks bracing for potential recessionary feedback.");
                signalTriggered = true;
            }

            if (Math.abs(spyChange) > 0.005) {
                pushToFeed("GS STRATEGY", spyChange > 0 ? "Momentum breakout confirmed in broad equities." : "Equity liquidation detected across major indices.", spyChange > 0 ? "Expect continued 'Risk-On' flows unless yields spike." : "Flight to safety potentially starting; monitoring DXY.");
                signalTriggered = true;
            }

            if (Math.abs(dxyChange) > 0.004) {
                pushToFeed("BLOOMBERG", dxyChange > 0 ? "U.S. Dollar Index (DXY) showing significant strength." : "Dollar weakness accelerating on global trade headlines.", dxyChange > 0 ? "Potential headwind for multinationals." : "Provides breathing room for EM debt and Gold.");
                signalTriggered = true;
            }

            const now = Date.now();
            if (!signalTriggered && (now - lastPulseTime > 20000)) {
                const randomPulse = baselineSignals[Math.floor(Math.random() * baselineSignals.length)];
                pushToFeed(randomPulse.desk, randomPulse.text, randomPulse.impact);
                lastPulseTime = now;
            }
        }
        function toggleSource() {
            if (isRealData) {
                isRealData = false;
                document.getElementById('toggle-source-btn').textContent = "Go Live";
                document.getElementById('toggle-source-btn').classList.remove('active-source');
                document.getElementById('status-text').textContent = "Simulated Feed";
                startSimulationMode();
            } else {
                fetchAllData();
            }
        }

        function resetAll() {
            [...EQUIPMENT.equities, ...EQUIPMENT.rates, ...EQUIPMENT.sectors, ...EQUIPMENT.commodities, ...EQUIPMENT.currencies].forEach(idx => {
                state[idx.symbol] = {
                    dataPoints: [],
                    labels: [],
                    currentPrice: idx.base,
                    basePrice: idx.base
                };
            });
            isRealData = false;
            if (!isRealData) {
                document.getElementById('toggle-source-btn').textContent = "Go Live";
                document.getElementById('toggle-source-btn').classList.remove('active-source');
            }
            initUI();
            initChart();
            startSimulationMode();
        }

        function startSimulationMode() {
            if (updateInterval) clearInterval(updateInterval);
            // Pre-fill some data if empty
            [...EQUIPMENT.equities, ...EQUIPMENT.rates].forEach(idx => {
                if (state[idx.symbol].dataPoints.length === 0) {
                    const s = state[idx.symbol];
                    for (let i = 0; i < 60; i++) {
                        const scale = idx.isYield ? 0.005 : (idx.base * 0.001);
                        s.currentPrice += (Math.random() - 0.5) * scale;
                        s.dataPoints.push(s.currentPrice);
                        s.labels.push(new Date(Date.now() - (60 - i) * 60000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    }
                }
            });
            updateInterval = setInterval(updateSimulation, 2000);
        }

        window.onload = () => {
            initUI();
            initChart();
            startSimulationMode();
            updateSignalBox();
            loadPortfolio();
            populateSymbolDropdown();

            // Modal Accessibility: Close on ESC key
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideEdu();
                    closeAddPositionModal();
                }
            });

            // Modal Accessibility: Close on clicking overlay
            document.getElementById('edu-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edu-modal') hideEdu();
            });

            document.getElementById('add-position-modal').addEventListener('click', (e) => {
                if (e.target.id === 'add-position-modal') closeAddPositionModal();
            });

            // Update estimated cost when inputs change
            document.getElementById('position-symbol').addEventListener('change', updateEstimatedCost);
            document.getElementById('position-quantity').addEventListener('input', updateEstimatedCost);
        };

        // Portfolio Management Functions
        let selectedSide = 'long';

        function populateSymbolDropdown() {
            const select = document.getElementById('position-symbol');
            const allSymbols = [
                { group: 'Indexes', items: EQUIPMENT.equities },
                { group: 'Sectors', items: EQUIPMENT.sectors },
                { group: 'Industries', items: Object.values(EQUIPMENT.industries).flat() },
                { group: 'Stocks', items: EQUIPMENT.stocks }
            ];

            allSymbols.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.group;
                group.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.symbol;
                    option.textContent = `${item.symbol} - ${item.label}`;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            });
        }

        function selectSide(side) {
            selectedSide = side;
            document.getElementById('side-long').classList.toggle('active', side === 'long');
            document.getElementById('side-short').classList.toggle('active', side === 'short');
        }

        function updateEstimatedCost() {
            const symbol = document.getElementById('position-symbol').value;
            const quantity = parseInt(document.getElementById('position-quantity').value) || 0;

            if (symbol && quantity > 0 && state[symbol]) {
                const cost = state[symbol].currentPrice * quantity;
                document.getElementById('estimated-cost').textContent = `$${cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else {
                document.getElementById('estimated-cost').textContent = '$0.00';
            }
        }

        function openAddPositionModal(symbol = null) {
            document.getElementById('add-position-modal').classList.add('visible');
            if (symbol) {
                const select = document.getElementById('position-symbol');
                select.value = symbol;
                updateEstimatedCost();
            }
        }

        function closeAddPositionModal() {
            document.getElementById('add-position-modal').classList.remove('visible');
            document.getElementById('position-symbol').value = '';
            document.getElementById('position-quantity').value = '';
            selectedSide = 'long';
            selectSide('long');
            updateEstimatedCost();
        }

        function confirmAddPosition() {
            const symbol = document.getElementById('position-symbol').value;
            const quantity = parseInt(document.getElementById('position-quantity').value) || 0;

            if (!symbol || quantity <= 0) {
                alert('Please select a symbol and enter a valid quantity.');
                return;
            }

            const symbolData = [...EQUIPMENT.equities, ...EQUIPMENT.sectors, ...Object.values(EQUIPMENT.industries).flat(), ...EQUIPMENT.stocks]
                .find(s => s.symbol === symbol);

            if (!symbolData || !state[symbol]) {
                alert('Invalid symbol selected.');
                return;
            }

            const entryPrice = state[symbol].currentPrice;
            const cost = entryPrice * quantity;

            if (cost > portfolio.cash) {
                alert(`Insufficient cash. You have $${portfolio.cash.toLocaleString()} but need $${cost.toLocaleString()}.`);
                return;
            }

            // Check for existing position with same symbol and side
            const existingPos = portfolio.positions.find(p => p.symbol === symbol && p.side === selectedSide);

            if (existingPos) {
                // Consolidate with weighted average price
                const totalCost = (existingPos.quantity * existingPos.entryPrice) + (quantity * entryPrice);
                const newQuantity = existingPos.quantity + quantity;
                existingPos.entryPrice = totalCost / newQuantity;
                existingPos.quantity = newQuantity;
            } else {
                // Add new position
                portfolio.positions.push({
                    id: portfolio.nextPositionId++,
                    symbol: symbol,
                    label: symbolData.label,
                    quantity: quantity,
                    entryPrice: entryPrice,
                    entryTime: new Date().toISOString(),
                    side: selectedSide,
                    sector: symbolData.sector || null
                });
            }

            portfolio.cash -= cost;
            savePortfolio();
            updatePortfolioUI();
            closeAddPositionModal();
        }

        function closePosition(positionId) {
            const position = portfolio.positions.find(p => p.id === positionId);
            if (!position) return;

            const currentPrice = state[position.symbol].currentPrice;
            const pnl = calculatePositionPnL(position, currentPrice);
            const proceeds = (position.entryPrice * position.quantity) + pnl;

            portfolio.cash += proceeds;
            portfolio.positions = portfolio.positions.filter(p => p.id !== positionId);

            savePortfolio();
            updatePortfolioUI();
        }

        function calculatePositionPnL(position, currentPrice) {
            const priceDiff = currentPrice - position.entryPrice;
            const multiplier = position.side === 'long' ? 1 : -1;
            return priceDiff * position.quantity * multiplier;
        }

        function updatePortfolioUI() {
            let totalPositionValue = 0;
            let totalPnL = 0;

            // Update positions list
            const container = document.getElementById('positions-container');

            if (portfolio.positions.length === 0) {
                container.innerHTML = '<div class="empty-portfolio">No positions yet.<br>Click "Add Position" to start trading.</div>';
            } else {
                const positionsList = document.createElement('div');
                positionsList.className = 'positions-list';

                portfolio.positions.forEach(position => {
                    const currentPrice = state[position.symbol].currentPrice;
                    const pnl = calculatePositionPnL(position, currentPrice);
                    const pnlPct = (pnl / (position.entryPrice * position.quantity)) * 100;
                    const positionValue = (position.entryPrice * position.quantity) + pnl;

                    totalPositionValue += positionValue;
                    totalPnL += pnl;

                    const card = document.createElement('div');
                    card.className = 'position-card';
                    card.onclick = () => {
                        const symbolData = [...EQUIPMENT.equities, ...EQUIPMENT.sectors, ...Object.values(EQUIPMENT.industries).flat(), ...EQUIPMENT.stocks]
                            .find(s => s.symbol === position.symbol);
                        if (symbolData) switchIndex(symbolData);
                    };

                    card.innerHTML = `
                        <div class="position-header">
                            <span class="position-symbol">${position.symbol} ${position.side === 'short' ? '(SHORT)' : ''}</span>
                            <span class="position-close" onclick="event.stopPropagation(); closePosition(${position.id})">✕</span>
                        </div>
                        <div class="position-details">
                            <div class="position-detail">
                                <span class="position-detail-label">Qty</span>
                                <span class="position-detail-value">${position.quantity}</span>
                            </div>
                            <div class="position-detail">
                                <span class="position-detail-label">Entry</span>
                                <span class="position-detail-value">$${position.entryPrice.toFixed(2)}</span>
                            </div>
                            <div class="position-detail">
                                <span class="position-detail-label">Current</span>
                                <span class="position-detail-value">$${currentPrice.toFixed(2)}</span>
                            </div>
                            <div class="position-detail">
                                <span class="position-detail-label">Value</span>
                                <span class="position-detail-value">$${positionValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                            <div class="position-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
                                P&L: $${pnl.toFixed(2)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                            </div>
                        </div>
                    `;

                    positionsList.appendChild(card);
                });

                container.innerHTML = '';
                container.appendChild(positionsList);
            }

            // Update summary
            const totalValue = portfolio.cash + totalPositionValue;
            const totalReturn = ((totalValue - portfolio.startingCapital) / portfolio.startingCapital) * 100;

            document.getElementById('portfolio-total-value').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('portfolio-cash').textContent = `$${portfolio.cash.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const pnlEl = document.getElementById('portfolio-pnl');
            pnlEl.textContent = `$${totalPnL.toFixed(2)}`;
            pnlEl.className = `portfolio-stat-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;

            const returnEl = document.getElementById('portfolio-return');
            returnEl.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%`;
            returnEl.className = `portfolio-stat-value ${totalReturn >= 0 ? 'positive' : 'negative'}`;
        }
    </script>
</body>

</html>